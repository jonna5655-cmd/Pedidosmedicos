<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Recetario Médico Digital</title>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #134e4a 100%);
            --glass-bg: rgba(255, 255, 255, 0.07);
            --glass-border: rgba(255, 255, 255, 0.125);
            --accent-teal: #2dd4bf;
            --text-light: #f1f5f9;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-light);
            margin: 0; padding: 15px;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            width: 100%; max-width: 500px; margin-bottom: 15px; box-sizing: border-box;
        }

        .doctor-header { display: flex; justify-content: space-between; align-items: center; }
        
        .nav-buttons { display: flex; gap: 8px; }
        .nav-buttons button {
            background: rgba(255, 255, 255, 0.1); border: 1px solid var(--glass-border);
            color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 0.75rem;
        }

        h3 { margin: 0 0 15px 0; color: var(--accent-teal); font-size: 1.1rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 8px; }
        .input-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 4px; font-size: 0.85rem; opacity: 0.9; }

        input, select {
            width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--glass-border);
            background: rgba(0, 0, 0, 0.3); color: white; box-sizing: border-box; outline: none;
        }

        .hidden { display: none !important; }
        
        /* Contenedor de etiquetas de estudios seleccionados */
        .selected-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
        .tag-item { 
            background: var(--accent-teal); color: #0f172a; padding: 3px 8px; 
            border-radius: 6px; font-size: 0.75rem; font-weight: bold; display: flex; align-items: center; gap: 5px;
        }
        .tag-item span { cursor: pointer; color: #b91c1c; }

        .switch-container { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .switch-item { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; }
        .switch { position: relative; display: inline-block; width: 30px; height: 16px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #334155; transition: .4s; border-radius: 20px;
        }
        .slider:before {
            position: absolute; content: ""; height: 10px; width: 10px;
            left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent-teal); }
        input:checked + .slider:before { transform: translateX(14px); }

        .btn-toggle-group { display: flex; gap: 8px; }
        .btn-toggle {
            flex: 1; padding: 8px; border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.05); color: white; border-radius: 8px; cursor: pointer; font-size: 0.8rem;
        }
        .btn-toggle.active { background: var(--accent-teal); color: #0f172a; font-weight: bold; }

        .btn-submit {
            width: 100%; padding: 14px; background: var(--accent-teal); border: none;
            border-radius: 12px; color: #0f172a; font-weight: bold; cursor: pointer; margin-top: 15px;
        }

        .status-item {
            background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px;
            margin-bottom: 8px; border-left: 4px solid #fbbf24;
        }
        .status-item.en-curso { border-left-color: #2dd4bf; background: rgba(45, 212, 191, 0.1); }
        .tag { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .tag-pendiente { background: #fbbf24; color: #000; }
        .tag-curso { background: #2dd4bf; color: #000; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script src="conexion.js"></script>

    
</head>
<body>

    <div class="glass-card doctor-header">
        <div>
            <strong id="display-medico">Cargando...</strong>
            <span id="display-matricula" style="display:block; font-size: 0.75rem; opacity: 0.7;">M.P: --</span>
        </div>
        <div class="nav-buttons">
            <button onclick="location.href='perfil.html'">Perfil</button>
            <button onclick="location.href='login.html'" style="color: #fda4af;">Salir</button>
        </div>
    </div>

    <form id="orderForm" class="glass-card">
        <h3>Nueva Orden</h3>
        <div class="input-group">
            <label>Paciente / DNI</label>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="nombre" placeholder="Nombre" style="flex: 2;">
                <input type="number" id="dni" placeholder="DNI" style="flex: 1;">
            </div>
        </div>

        <div class="input-group">
            <label>Tipo de Solicitud</label>
            <select id="orderType" onchange="toggleVistas()">
                <option value="Traslado">Solo Traslado</option>
                <option value="RX">Estudio RX</option>
                <option value="TAC">Estudio TAC</option>
                <option value="RX+TAC">Ambos (RX + TAC)</option>
            </select>
        </div>

        <div id="sec-traslado" class="input-group">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <div><label>Desde</label><select id="desde"></select></div>
                <div><label>Hacia</label><select id="hacia"></select></div>
            </div>
        </div>

        <div id="sec-rx" class="hidden">
            <label>Seleccionar Estudios RX:</label>
            <select id="select-rx" onchange="addTag('rx')">
                <option value="">Añadir estudio...</option>
                <option value="Torax">Torax</option>
                <option value="Mano">Mano</option>
                <option value="Pelvis">Pelvis</option>
                <option value="Pierna">Pierna</option>
                <option value="Craneo">Cráneo</option>
                <option value="Columna Cervical">Columna Cervical</option>
                <option value="Columna Lumbar">Columna Lumbar</option>
                <option value="Abdomen">Abdomen</option>
            </select>
            <div id="tags-rx" class="selected-tags"></div>
            
            <div class="switch-container">
                <div class="switch-item"><label class="switch"><input type="checkbox" id="rx-frontal"><span class="slider"></span></label>Frontal</div>
                <div class="switch-item"><label class="switch"><input type="checkbox" id="rx-perfil"><span class="slider"></span></label>Perfil</div>
            </div>
        </div>

        <div id="sec-tac" class="hidden" style="margin-top:10px;">
            <label>Seleccionar Estudios TAC:</label>
            <select id="select-tac" onchange="addTag('tac')">
                <option value="">Añadir estudio...</option>
                <option value="Cerebro">Cerebro</option>
                <option value="Abdomen">Abdomen</option>
                <option value="Torax">Torax</option>
                <option value="Macizo Facial">Macizo Facial</option>
                <option value="Pelvis">Pelvis</option>
                <option value="Cuello">Cuello</option>
            </select>
            <div id="tags-tac" class="selected-tags"></div>

            <div class="switch-container">
                <div class="switch-item"><label class="switch"><input type="checkbox" id="tac-simple"><span class="slider"></span></label>Simple</div>
                <div class="switch-item"><label class="switch"><input type="checkbox" id="tac-contraste"><span class="slider"></span></label>C/C</div>
                <div class="switch-item"><label class="switch"><input type="checkbox" id="tac-3d"><span class="slider"></span></label>3D</div>
            </div>
        </div>

        <h3 style="margin-top:15px; font-size: 0.9rem;">Transporte y Oxígeno</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="btn-toggle-group">
                <button type="button" class="btn-toggle" onclick="setToggle(this, 'transport')">Silla</button>
                <button type="button" class="btn-toggle" onclick="setToggle(this, 'transport')">Camilla</button>
            </div>
            <div class="btn-toggle-group">
                <button type="button" class="btn-toggle" onclick="setToggle(this, 'oxigeno')">O2 Si</button>
                <button type="button" class="btn-toggle" onclick="setToggle(this, 'oxigeno')">O2 No</button>
            </div>
        </div>

        <button type="button" class="btn-submit" onclick="enviarPedido()">ENVIAR PEDIDO</button>
    </form>

    <div class="glass-card">
        <h4 style="margin:0 0 10px 0; font-size: 0.9rem;">Monitor de Pedidos</h4>
        <div id="listaPendientes"></div>
    </div>

    <script>
        let seleccionCamillero = { transport: '', oxigeno: '' };
        let estudiosRX = [];
        let estudiosTAC = [];

        window.onload = function() {
            document.getElementById('display-medico').innerText = "Dr/a. " + (localStorage.getItem('reg-medico-nombre') || "Profesional");
            document.getElementById('display-matricula').innerText = "M.P: " + (localStorage.getItem('reg-medico-mat') || "----");
            
            const salas = ["Guardia", "Piso 1", "Piso 2", "UTI", "Shock Room", "Quirófano", "RX", "TAC", "Maternidad"];
            const s1 = document.getElementById('desde');
            const s2 = document.getElementById('hacia');
            salas.forEach(s => { s1.add(new Option(s, s)); s2.add(new Option(s, s)); });
            
            actualizarLista();
            setInterval(actualizarLista, 4000);
        };

        function addTag(tipo) {
            const select = document.getElementById(`select-${tipo}`);
            const val = select.value;
            if (!val) return;

            if (tipo === 'rx' && !estudiosRX.includes(val)) estudiosRX.push(val);
            if (tipo === 'tac' && !estudiosTAC.includes(val)) estudiosTAC.push(val);

            renderTags();
            select.value = "";
        }

        function removeTag(tipo, val) {
            if (tipo === 'rx') estudiosRX = estudiosRX.filter(item => item !== val);
            if (tipo === 'tac') estudiosTAC = estudiosTAC.filter(item => item !== val);
            renderTags();
        }

        function renderTags() {
            const containerRX = document.getElementById('tags-rx');
            const containerTAC = document.getElementById('tags-tac');
            
            containerRX.innerHTML = estudiosRX.map(item => `
                <div class="tag-item">${item} <span onclick="removeTag('rx', '${item}')">×</span></div>
            `).join('');

            containerTAC.innerHTML = estudiosTAC.map(item => `
                <div class="tag-item">${item} <span onclick="removeTag('tac', '${item}')">×</span></div>
            `).join('');
        }

        function toggleVistas() {
            const val = document.getElementById('orderType').value;
            document.getElementById('sec-traslado').classList.toggle('hidden', val === 'RX' || val === 'TAC');
            document.getElementById('sec-rx').classList.toggle('hidden', !val.includes('RX'));
            document.getElementById('sec-tac').classList.toggle('hidden', !val.includes('TAC'));
        }

        function setToggle(btn, tipo) {
            btn.parentElement.querySelectorAll('.btn-toggle').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            seleccionCamillero[tipo] = btn.innerText;
        }

        function determinarTurno(h) {
            if (h >= 7 && h < 14) return "Mañana (07:00 - 14:00)";
            if (h >= 14 && h < 21) return "Tarde (14:00 - 21:00)";
            return "Noche (21:00 - 07:00)";
        }

        function enviarPedido() {
            const nom = document.getElementById('nombre').value;
            const dni = document.getElementById('dni').value;
            const tipo = document.getElementById('orderType').value;
            
            if(!nom || !dni || !seleccionCamillero.transport) return alert("Complete los datos del paciente y transporte.");

            let detalleEstudio = "";
            if(tipo.includes("RX")) {
                let m = [];
                if(document.getElementById('rx-frontal').checked) m.push("F");
                if(document.getElementById('rx-perfil').checked) m.push("P");
                detalleEstudio += `RX: ${estudiosRX.join(", ")} (${m.join("/")}) `;
            }
            if(tipo.includes("TAC")) {
                let m = [];
                if(document.getElementById('tac-simple').checked) m.push("S");
                if(document.getElementById('tac-contraste').checked) m.push("C/C");
                if(document.getElementById('tac-3d').checked) m.push("3D");
                detalleEstudio += `TAC: ${estudiosTAC.join(", ")} [${m.join("/")}]`;
            }

            const ahora = new Date();
            const nuevo = {
                id: Date.now(),
                paciente: nom.toUpperCase(),
                dni: dni,
                estudio: detalleEstudio || "Traslado General",
                desde: tipo === 'RX' || tipo === 'TAC' ? 'Origen' : document.getElementById('desde').value,
                hacia: tipo === 'RX' || tipo === 'TAC' ? tipo : document.getElementById('hacia').value,
                transporte: seleccionCamillero.transport,
                o2: seleccionCamillero.oxigeno,
                hora: ahora.getHours() + ":" + ahora.getMinutes().toString().padStart(2, '0'),
                turno: determinarTurno(ahora.getHours()),
                estado: 'pendiente',
                camilleroAsignado: '',
                medico: localStorage.getItem('reg-medico-nombre'),
                firma: localStorage.getItem('user-firma')
            };

            let cola = JSON.parse(localStorage.getItem('cola-pedidos')) || [];
            cola.push(nuevo);
            localStorage.setItem('cola-pedidos', JSON.stringify(cola));

            alert("Pedido enviado.");
            document.getElementById('orderForm').reset();
            estudiosRX = []; estudiosTAC = [];
            renderTags();
            actualizarLista();
        }

        function actualizarLista() {
            const cola = JSON.parse(localStorage.getItem('cola-pedidos')) || [];
            const container = document.getElementById('listaPendientes');
            container.innerHTML = "";
            cola.slice(-5).reverse().forEach(p => {
                const div = document.createElement('div');
                div.className = `status-item ${p.estado === 'en-curso' ? 'en-curso' : ''}`;
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <strong>${p.paciente}</strong>
                        <span class="tag ${p.estado === 'en-curso' ? 'tag-curso' : 'tag-pendiente'}">
                            ${p.estado === 'en-curso' ? 'EN CURSO' : 'PENDIENTE'}
                        </span>
                    </div>
                    <div style="font-size:0.75rem; margin-top:5px;">${p.estudio}</div>
                `;
                container.appendChild(div);
            });
        }
    </script>
</body>
</html>
